<script>     
        function controlPage() {
                window.location.href = '/usuarios/control'
        }

        let projects = JSON.parse('<%- projectsJSON %>')
        const projPorPage = 9
        let currentFilter = "id"
        let searchTerm = ""
        let currentPage = 1
        const searchSubmit = document.getElementById('button-addon2')
        const searchInput = document.getElementById('search-input')
        cambiarPagina(currentPage)

        searchSubmit.addEventListener('click', handleSearch)

        searchInput.addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                        handleSearch()
                }
        })

        function handleFilterChange(selectElement) {
                currentFilter = selectElement.value
                filterProjects(searchTerm, currentFilter, currentPage)
        }

        function handleSearch() {
                searchTerm = searchInput.value.toLowerCase()
                filterProjects(searchTerm, currentFilter, currentPage)
        }

        // function cambiarPagina(numPagina) {
        //         currentPage = numPagina
        //         filterProjects(searchTerm, currentFilter, currentPage)
        // }

        function cambiarPagina(numPagina) {
                const rangeHigh = numPagina*projPorPage - 1
                const rangeLow = (numPagina-1)*projPorPage

                projects.map((project, i) => {
                        if (i >= rangeLow && i <= rangeHigh) {
                                project.active = true
                        } else {
                                project.active = false
                        }
                })
                filterProjects('', currentFilter)
        }

        function filterProjects(searchTerm, currentFilter, currentPage) {
                const filteredProjects = projects.filter(project =>
                        project.Nombre.toLowerCase().includes(searchTerm) || 
                        project.Descripcion.toLowerCase().includes(searchTerm) ||
                        project.nombreEmpresa.toLowerCase().includes(searchTerm)
                )

// Esta parte del codigo filtra los projectos activos segun la pagina en la que estemos.
                const rangeHigh = currentPage*projPorPage - 1
                const rangeLow = (currentPage-1)*projPorPage

                filteredProjects.map((project, i) => {
                        if (i >= rangeLow && (rangeHigh >=i)){
                                project.active = true
                        }
                })

                console.log(searchTerm)
                console.log(filteredProjects)
                console.log(projects.length)

                if (currentFilter === "FechaInicio") {
                        filteredProjects.sort((a, b) => new Date(a.FechaInicio) - new Date(b.FechaInicio))
                } else if (currentFilter === "FechaFinal") {
                        filteredProjects.sort((a, b) => new Date(a.FechaFinal) - new Date(b.FechaFinal))
                } else if (currentFilter === "Viabilidad") {
                        filteredProjects.sort((a, b) => b.Viabilidad - a.Viabilidad)
                } else if (currentFilter === "Costo") {
                        filteredProjects.sort((a, b) => a.Costo - b.Costo)
                } else if (currentFilter === "ID") {
                        filteredProjects.sort((a, b) => a.IDProyecto = b.IDProyecto)
                }

                console.log("pass current filter")

                // let previouslyInactive = []

                // filteredProjects.forEach(project => {
                //         if (!project.active) {
                //         project.active = true
                //         previouslyInactive.push(project)
                //         }
                // })

                const projectCards = document.getElementById('project-cards')
                projectCards.innerHTML = ''

                filteredProjects.forEach(project => {
                        //console.log("hello")
                        console.log(project.active)
                        if (project.active == true) {
                                console.log(project.active)
                                const anchor = document.createElement('a')
                                anchor.href = '/proyecto/' + project.IDProyecto

                                const card = document.createElement('div')
                                card.className = 'card'
                                card.style = 'width: 20rem; height: 17rem;'

                                const cardBody = document.createElement('div')
                                cardBody.className = 'card-body'

                                const titleScoreDiv = document.createElement('div')
                                titleScoreDiv.className = 'flex-3'

                                const title = document.createElement('h5')
                                title.className = 'card-title'
                                title.textContent = project.Nombre

                                const viability = document.createElement('p')
                                if (project.Viabilidad == null){
                                        viability.className = "blank"
                                } else if (project.Viabilidad < 50) { 
                                        viability.className = 'very-risky' 
                                } else if (project.Viabilidad < 65){ 
                                        viability.className='at-risk'
                                } else if (project.Viabilidad < 80){ 
                                        viability.className='viable'
                                } else if (project.Viabilidad < 95){ 
                                        viability.className='very-viable'
                                } else if (project.Viabilidad <= 100){ 
                                        viability.className='perfect'
                                } 

                                if (project.Viabilidad == null) {
                                        viability.textContent = "?"        
                                } else {
                                        viability.textContent = project.Viabilidad
                                }
                                const client = document.createElement('h6')
                                client.className = 'card-subtitle mb-2 text-body-secondary'
                                client.textContent = 'Cliente: ' + project.nombreEmpresa

                                const descTitle = document.createElement('h6')
                                descTitle.textContent = 'Descripcion'

                                const description = document.createElement('p')
                                description.className = 'card-text p-desc'
                                description.textContent = project.Descripcion

                                const fechasLabelDiv = document.createElement('div')
                                fechasLabelDiv.className = 'fechas-div'

                                const fechaInicio = document.createElement('p')
                                fechaInicio.className = 'card-text'
                                fechaInicio.textContent = 'Inicio'

                                const fechaFin = document.createElement('p')
                                fechaFin.className = 'card-text'
                                fechaFin.textContent = 'Fin'

                                const fechasDiv = document.createElement('div')
                                fechasDiv.className = 'fechas-div'

                                const fechaStart = document.createElement('p')
                                fechaStart.className = 'card-text'
                                fechaStart.textContent = project.start

                                const fechaEnd = document.createElement('p')
                                fechaEnd.className = 'card-text'
                                fechaEnd.textContent = project.end
                                        
                                titleScoreDiv.append(title)
                                titleScoreDiv.append(viability)

                                fechasLabelDiv.append(fechaInicio)
                                fechasLabelDiv.append(fechaFin)

                                fechasDiv.append(fechaStart)
                                fechasDiv.append(fechaEnd)

                                cardBody.append(titleScoreDiv)
                                cardBody.append(client)
                                cardBody.append(descTitle)
                                cardBody.append(description)
                                cardBody.append(fechasLabelDiv)
                                cardBody.append(fechasDiv)

                                card.appendChild(cardBody)

                                anchor.append(card)
                                
                                console.log(anchor)
                                projectCards.appendChild(anchor)
                        }
                                 
                })

                filteredProjects.map((projecto)=> {
                        projecto.active = false
                })

                // previouslyInactive.forEach(project => {
                //         project.active = false
                // })
        }

        var btnAbrirPopup = document.getElementById('btn-abrir-popup'),
	        overlay = document.getElementById('overlay'),
	        popup = document.getElementById('popup'),
	        btnCerrarPopup = document.getElementById('btn-cerrar-popup');

        btnAbrirPopup.addEventListener('click', function(){
	        console.log("got here")
	        overlay.classList.add('active');
	        popup.classList.add('active');
        });

        btnCerrarPopup.addEventListener('click', function(e){
	        e.preventDefault();
	        overlay.classList.remove('active');
	        popup.classList.remove('active');
        });

        // Popup Agregar Proyecto
        var btnAbrirAgregarEmpresaPopup = document.getElementById('btn-abrir-AgregarProyecto-popup'),
	        overlay2 = document.getElementById('overlayAgregarProyecto'),
	        popup2 = document.getElementById('popup2'),
	        btnCerrarPopup2 = document.getElementById('btn-cerrar-popup-2');

        btnAbrirAgregarEmpresaPopup.addEventListener('click', function(){
	        console.log("got here")
	        overlay2.classList.add('active');
	        popup2.classList.add('active');
        });

        btnCerrarPopup2.addEventListener('click', function(e){
	        e.preventDefault();
	        overlay2.classList.remove('active');
	        popup2.classList.remove('active');
        });
</script>