<script>
    function backHome() {
        window.location.href = '/usuarios/homePage'
    }

    let usuariosData = JSON.parse('<%- usuariosJSON %>')
    // console.log(usuariosData)

    let proyectosData = JSON.parse('<%- usuarioProyectosJSON %>')
    // console.log(proyectosData)

    const { h } = gridjs

    const grid = new gridjs.Grid({
        columns: [
        'ID',
        'Nombre',
        'Correo',
        'Rol',
        'Fecha Creado',
        { 
        name: 'Acciones',
        formatter: (cell, row) => {
          return h('button', {
            // className: 'py-2 mb-4 px-4 border rounded-md text-white bg-blue-600 edit-box',
            className: 'button-23 zsss',

            onClick: () => editUser(row.cells[0].data)
          }, 'Edit')
        }
      }
        ],
        sort: true,
        search: true,
        fixedHeader: true,
        height: '400px',
        data: usuariosData.map(user => [
                    user.IDUsuario, user.Nombre, user.Correo, user.Rol, user.dateAdded
                ]),
        style: {
            th: {
                'background-color': 'skyblue',
                'color': 'black',
                'z-index': '2'
            },
            td: {
                'text-align': 'center'
            }
        }
    })

    grid.render(document.getElementById('grid-container'))

    function editUser(idUser) {
        let user = usuariosData.filter(user => user.IDUsuario == idUser)
        user = user[0]

        const userProjects = proyectosData.filter(relationship => {
            return relationship.IDUsuario == idUser
        })

        const overlay = document.createElement('div')
        overlay.className = 'overlay'

        const popup = document.createElement('div')
        popup.className = 'popup'
        overlay.appendChild(popup)

        const close = document.createElement('a')
        close.className = 'btn-cerrar-popup'
        const i = document.createElement('i')
        i.className = 'fa fa-times'
        close.appendChild(i)
        popup.appendChild(close)

        const title = document.createElement('h3')
        title.textContent = user.Nombre
        title.style = "margin-bottom: 2rem;"
        popup.appendChild(title)

        const hemis = document.createElement('div')
        hemis.className = "hemis-div"
        popup.append(hemis)

        const leftHemi = document.createElement('div')
        leftHemi.style = "flex-basis: 50%; height: 100%; text-align: start;"
        hemis.appendChild(leftHemi)

        const leftTitle = document.createElement('h6')
        leftTitle.textContent = "Datos Generales"
        leftTitle.style = 'border-bottom: solid black 1px;'
        leftHemi.appendChild(leftTitle)

        const correoLine = document.createElement('p')
        correoLine.textContent = "Correo: " + user.Correo
        const contrasenaLine = document.createElement('p')
        contrasenaLine.textContent = "Contrasena: " + user.Contrasena
        const rolLine = document.createElement('p')
        rolLine.textContent = "Rol: " + user.Rol
        leftHemi.appendChild(correoLine)
        leftHemi.appendChild(contrasenaLine)
        leftHemi.appendChild(rolLine)

        const rightHemi = document.createElement('div')
            rightHemi.style = "flex-basis: 50%; height: 100%; text-align: start;"
            hemis.append(rightHemi)

        if (user.Rol == 'desarrollador') {
            const proyectosTabla = document.createElement('div')
            proyectosTabla.style = "width: 100%;"
            if(userProjects.length >= 4) {
                proyectosTabla.style = "overflow: scroll; overflow-x: hidden"
            }
            rightHemi.appendChild(proyectosTabla)

            const rightTitle = document.createElement('h6')
            rightTitle.textContent = "Proyectos Involucrados"
            rightTitle.style = 'border-bottom: solid black 1px;'
            proyectosTabla.appendChild(rightTitle)

            const proyectosLista = document.createElement('ul')
            proyectosLista.className = 'popup-list'
            proyectosTabla.appendChild(proyectosLista)

            if (userProjects.length == 0) {
                const line = document.createElement('li')
                line.textContent = user.Nombre + ' no está asignado a ningún proyecto'
                proyectosLista.appendChild(line)
            }
            else {
                userProjects.forEach(project => {
                const line = document.createElement('li')
                line.textContent = project.IDProyecto + ': ' + project.Nombre
                proyectosLista.appendChild(line)
            })
            }

        } else {
            const managerMssg = document.createElement('p')
            managerMssg.textContent = "Manager está involucrado en todos los proyectos"
            rightHemi.appendChild(managerMssg)
        }

        overlay.classList.add('active')
        popup.classList.add('active')

        document.body.appendChild(overlay)

        close.addEventListener('click', () => {
            overlay.classList.remove('active')
            popup.classList.remove('active')
            document.body.removeChild(overlay)
        })
    }

    var btnAbrirPopup = document.getElementById('btn-abrir-popup'),
	        overlay = document.getElementById('overlay'),
	        popup = document.getElementById('popup'),
	        btnCerrarPopup = document.getElementById('btn-cerrar-popup')

        btnAbrirPopup.addEventListener('click', function(){
	        console.log("got here")
	        overlay.classList.add('active')
	        popup.classList.add('active')
        })

        btnCerrarPopup.addEventListener('click', function(e){
	        e.preventDefault()
	        overlay.classList.remove('active')
	        popup.classList.remove('active')
        })    
</script>