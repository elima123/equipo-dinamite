<!DOCTYPE html>
<head>
  <%- include('./../includes/head.html') %>
    <link rel="stylesheet" href="/styles/proj-styles.css">
    <title>Proyecto: <%= proyectoObject.IDProyecto %></title>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/highcharts-more.js"></script>
    <script src="https://code.highcharts.com/modules/solid-gauge.js"></script>
</head>
<body>
  <nav class="universal-nav">
    <div class="flex-1">
      <%- include('./../includes/go-back.html') %>
        <img src="/imgs/logo_blanco.png" alt="Appix">
    </div>
    <div class="flex-2">
      <%- include('./../includes/person_icon.html') %>
      <p><%= user.name %></p>
      <% if (user.rol=="manager" ) { %>
        <p>(M)</p>
      <% } else if (user.Rol=="desarrollador" ){ %>
          <p>(D)</p>
      <% } %>
    </div>
  </nav>

  <ul class="nav nav-tabs"> 
    <li class="nav-item">
      <a class="nav-link active" id="navtab-1" aria-current="page" onclick="viewInfo()">Info de Proyecto</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="navtab-2" onclick="viewRiesgos()">Info Riesgos</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="navtab-3" onclick="viewAnalisis()">Análisis</a>
    </li>
  </ul>

  <section class="general-view">
    <div class="flex-3 general-title">
      <h1><%= proyectoObject.Nombre %></h1>
      <div class="flex-3" style="flex-basis: 35%; position: relative; left: 11rem;">
        <button role="none" class="button-23" style="color: blue; border-color: blue;" id="btn-abrir-edit-p">Editar Proyecto</button>
        <button role="none" class="button-23" style="color: red; border-color: red;" id="btn-abrir-popup">Cerrar Proyecto</button>
      </div>
    </div>

    <div class="flex-3" style="align-items: center; margin-bottom: 2rem;">
      <div class="f-50" style="line-height: 1rem; padding: 0; flex-basis: 33%;">
        <h5 class="card-subtitle mb-2" style="margin: 0 0 0 3rem;  padding: 0;">
          Cliente: <%= proyectoObject.nombreEmpresa %>
        </h5><br>
        <div style="width: 100%; color: darkslategray;">
          <p style="width: 100%; text-align: start; margin: 0 0 0 4rem;">Cel: <%= proyectoObject.telEmpresa %></p>
          <p style="width: 100%; text-align: start; margin: 0 0 0 4rem;">Correo: <%= proyectoObject.correoEmpresa %></p>
        </div>
      </div>
      <div style=" flex-grow: 2; text-align: center; height: 100%;">
        <h5 style="border-bottom: solid black 1px; width: 60%;">Costo</h5>
        <p>$<%= proyectoObject.Costo %></p>
      </div>
      <div style="flex-basis: 45%; text-align: start;">
        <h6 style="max-width: 100%;">Progreso de Timeline de Proyecto</h6>
        <div class="flex-3" style="width: 80%; justify-content: space-between; margin: 0;">
          <label><%= proyectoObject.start %></label>
          <label><%= proyectoObject.end %></label>
        </div>
        <div class="progress" role="progressbar" id="prog-bar"></div>
          <!-- <div class="progress-bar" style="width: 50%"></div> -->
        <!-- </div> -->
        <div id="range-div" style="width: 100%;"></div>
      </div>
    </div>

    <div class="flex-3 info-body">
      <% if (projectDevs.length >= 6) { %>
        <div class="card card-scroll">
          <div class="card-body card-body-scroll" style="max-height: 6rem;">
      <% } else { %>
              <div class="card">
                <div class="card-body" style="max-height: 6rem;">
      <% } %>
                    <h5 class="card-title">Descripción</h5>
                    <p class="card-text" style="width: 100%;">
                      <%= proyectoObject.Descripcion %>
                    </p>
                </div>
                <h6 class="card-subtitle mb-2" style="margin-left: 1rem;">Desarrolladores Actuales</h6>
                <ul class="list-group list-group-flush">
                  <% projectDevs.forEach(dev => { %>
                    <% if (dev.Rol == 'desarrollador') { %>
                      <li class="list-group-item"><%= dev.IDUsuario %>: <%= dev.Nombre %> (Agregado <%= dev.dateAdded %>)</li>
                    <% } %>
                  <% }) %>
                  <% if(riesgos.length == 0) { %>
                    <li class="list-group-item">Aún no hay desarrolladores asignados a este proyecto</li>
                  <% } %>
                </ul>
              </div>
              <div style="flex-basis: 45%; height: 100%; text-align: start;">
                <div id="container-viable" style="width: 80%; max-height: 70%; display: inline-block; border: solid black 1px; margin: 0 auto;"></div>
              </div>
            </div>

  </section>

  <div class="riesgos-view hidden">
    <div class="flex-3" style=" width: 90%; margin-bottom: 2rem;">
      <h1><%= proyectoObject.Nombre %></h1>
      <div class="flex-3" style="flex-basis: 35%; position: relative; left: 11rem;">
        <button id="btn-crearRiesgo" role="none" class="button-23" style="color: green; border-color: green;">
          Crear Riesgo
        </button>
        <button id="btn-EditarRiesgos-abrir" role="none" class="button-23" style="color: orange; border-color: orange;">
          Editar Riesgos
        </button>
      </div>

    </div>
    <h4>Riesgos Anotados</h4>
    <table class="table table-striped" style="margin-bottom: 3rem; width: 95%;">
      <thead>
        <tr>
          <th scope="col">IDRiesgo</th>
          <th scope="col">Riesgo</th>
          <th scope="col">Categoria</th>
          <th scope="col">Probabilidad</th>
          <th scope="col">Impacto</th>
          <th scope="col">Estrategia</th>
        </tr>
      </thead>
      <tbody>
        <% riesgos.forEach(riesgo => { %>
          <tr >
              <td><%= riesgo.IDRiesgo %></td>
              <td><%= riesgo.Riesgo %></td>
              <td><%= riesgo.Categoria %></td>
              <td><%= riesgo.Probabilidad %></td>
              <td><%= riesgo.Impacto %></td>
              <td><%= riesgo.Estrategia %></td>
          </tr>
      <% }) %>
    </tbody>
    </table>
  </div>

  <div class="analisis-view hidden">
    <h1 style="text-align: center; margin-bottom: 2rem;"><%= proyectoObject.Nombre %></h1>
    <div class="flex-3 graph-div">
      <div id="container" style="width: 49%; height: 400px;"></div>
      <div id="container-2" style="width: 49%; height: 400px;"></div>
    </div>
  </div>

  <footer>
    <p style="display: inline-block">Powered by: </p>
    <img src="/imgs/dinamite_logo.png" width="240">
  </footer>

  <!-- AQUI EMPIEZAN TODOS LOS POPUPS -->

  <!-- Popup para Editar Proyecto -->
  <div id="overlay-edit-p" class="overlay">
    <div class="popup" id="popup-edit-p" style="height: 83vh; overflow: scroll; overflow-x: hidden;">
      <a id="btn-cerrar-popup-p" class="btn-cerrar-popup"><i class="fas fa-times"></i></a>
      <h3 style="margin-bottom: 2rem; color: darkslategray;">Cambiar Información Actual</h3>
      <ul class="nav nav-underline">
        <li class="nav-item">
          <a class="nav-link active" id="a-1" onclick="popViewInfo()">Info General</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" id="a-2" onclick="popViewDes()">Quitar Devs</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" id="a-3" onclick="popViewAgreg()">Agregar Devs</a>
        </li>
      </ul>
      <div id="editar-info">
        <p style="color: gray;">Editar la informacion a su gusto</p>
        <form action="/proyecto/editarProyecto" method="POST">
          <div class="contenedor-inputs" style="text-align: start;">
            <input type="hidden" name="idProyecto" value="<%= proyectoObject.IDProyecto %>">
            <label>Nombre</label>
            <input type="text" name="nombre" value="<%= proyectoObject.Nombre %>">
            <label>Descripcion</label>
            <input type="text" name="descripcion" value="<%= proyectoObject.Descripcion %>">
            <div class="flex-3">
              <label>Fecha de Inicio</label>
              <label style="width: 50%; text-align: start;">Fecha Final</label>
            </div>
            <div class="flex-3" id="fechas-div-pop">
              <!-- <input type="date" name="fechaInicio" value="<%= proyectoObject.start %>">
              <input type="date" name="fechaFinal" value="<%= proyectoObject.end %>"> -->
            </div>
            <label>Costo</label>
            <input type="number" name="costo" value="<%= proyectoObject.Costo %>">
            <div style="width: 100%; display: flex; justify-content: center;">
              <button role="none" type="submit" class="btn-submit">Actualizar</button>
            </div>
          </div>
        </form>
      </div>

      <div class="hidden" id="editar-desarrolladores">
        <p style="color: gray;">Quitar desarrolladores del proyecto</p>
          <h6 class="card-subtitle mb-2" style="margin-left: 1rem;">Desarrolladores Actuales</h6>
          <ul class="list-group list-group-flush">
            <% projectDevs.forEach(dev => { %>
                <% if (dev.Rol == 'desarrollador') { %>
                  <form action="/proyecto/quitarDev" method="POST">
                    <input type="hidden" name="idUsuario" value="<%= dev.IDUsuario %>">
                    <input type="hidden" name="idProyecto" value="<%= proyectoObject.IDProyecto %>">
                    <li class="list-group-item" style="display: flex; align-items: center;">
                      <span style="flex: 1;"><%= dev.IDUsuario %>: <%= dev.Nombre %> (Agregado <%= dev.dateAdded %>)</span>
                      <button class="button-23" type="submit" style="margin-left: auto; padding: 0.5rem; color: red; border-color: red;"><%- include('./../includes/remove_des.html') %></button>
                    </li>
                  </form>
                <% } %>
            <% }) %>
                <% if(riesgos.length == 0) { %>
                      <li class="list-group-item">Aún no hay desarrolladores asignados a este proyecto</li>
                <% } %>
          </ul>
      </div>

      <div class="hidden" id="agregar-des">
          <p style="color: gray;">Agregar desarrolladores al proyecto</p>
          <h6 class="card-subtitle mb-2" style="margin-left: 1rem;">Desarrolladores Disponibles</h6>
          <form action="/proyecto/agregarDev" method="POST">
            <input type="hidden" name="idProyecto" value="<%= proyectoObject.IDProyecto %>">
            <select name="idUsuario">
              <% for (i = 0; i < nonDevs.length; i++) { %>
                <option value="<%= nonDevs[i].IDUsuario %>"><%= nonDevs[i].IDUsuario %>: <%= nonDevs[i].Nombre %></option>
              <% } %>
            </select>
            <button class="btn-submit" type="submit">Agregar</button>
          </form>
      </div>

    </div>
  </div>

  <!-- Popup para Cerrar Proyecto -->
  <div id="overlay" class="overlay">
    <div class="popup" id="popup">
      <a id="btn-cerrar-popup" class="btn-cerrar-popup"><i class="fas fa-times"></i></a>
      <h3 style="margin-bottom: 2rem; color: darkslategray;">Cerrar Proyecto: <span style="color: black;"><%= proyectoObject.Nombre %></span></h3>
      <form action="/proyecto/cerrar" method="POST" onsubmit="cleanTextArea()">
        <div class="contenedor-inputs">
          <input type="hidden" name="idProyecto" value="<%= proyectoObject.IDProyecto %>">
          <h5>Cual es la razón por cerrar el proyecto?</h5>
          <p style="color: gray; font-size: small;">(opcional, se puede dejar vacio)</p>
          <textarea placeholder="Falta de recursos, otra cosa... " rows="2" cols="60" name="razon">
          </textarea><br>
          <div id="popup-2" class="hidden">
            <h5>Seguro que deseas cerrar este proyecto?</h5>
            <p style="color: gray; font-size: small;">Si no, puedes salir de aqui dando clic en la 'X' en la parte superior de este popup</p>
            <input type="checkbox" id="are-you-sure" onclick="verificar()"><br>
            <p style="color: red;" id="warning-red" class="hidden">Esta accion no se puede deshacer</p>
            <button type="submit" id="cerrar-submit" class="btn-submit hidden">Finalizar</button>
          </div>
          <button role="none" type="button" id="btn-verificacion" class="btn-submit">Cerrar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Popup para crear riesgo -->
  <div id="overlay-cr" class="overlay">
    <div class="popup" id="popup-cr">
      <a id="btn-cerrar-popup-cr" class="btn-cerrar-popup"><i class="fas fa-times"></i></a>
      <h3 style="margin-bottom: 2rem; color: darkslategray;">Crear Riesgo</h3>
      <form action="/proyecto/crearRiesgo" method="POST">
        <div class="contenedor-inputs">
          <input type="text" placeholder="descripción del riesgo..." name="riesgo">
          <select name="categoria">
            <option value="" class="placeholder">Categoria</option>
            <option value="Alcance">Alcance</option>
            <option value="Calidad">Calidad</option>
            <option value="Costo">Costo</option>
            <option value="Recursos">Recursos</option>
            <option value="Tiempo">Tiempo</option>
          </select>
          <select name="probabilidad">
            <option value="" class="placeholder">Probabilidad</option>
            <option value="Alcance">Alta</option>
            <option value="Calidad">Media</option>
            <option value="Costo">Baja</option>
          </select>
          <select name="impacto">
            <option value="" class="placeholder">Impacto</option>
            <option value="Alcance">Alto</option>
            <option value="Calidad">Medio</option>
            <option value="Costo">Bajo</option>
          </select>
          <input type="text" placeholder="estrategia para atender este riesgo..." name="estrategia">
          <button type="submit" class="btn-submit">Crear Riesgo</button>          
        </div>
      </form>
    </div>
  </div>

  <!-- IMPLEMENTACIÓN : FUNCIONALIDAD DEL BOTÓN "Editar Riesgos" -->
  <div id="EditarRiesgos" class="overlay">
      <div class="popup" id="riesgos-popup" style="z-index: 9999; height: 83vh; overflow: scroll; overflow-x: hidden;" >
      <a id="btn-EditarRiesgos-cerrar" class="btn-cerrar-popup"><i class="fas fa-times"></i></a>
      <h3>Seleccione los cambios que desea hacer a los riesgos.</h3>
      <p>(O si prefiere, puede salir sin hacer cambios dando clic en la X)</p>
      <form id="editarRiesgosForm" action="/proyecto/editarRiesgo" method="POST">
        <input type="hidden" id="idProyectoHidden" value="<%= proyectoObject.IDProyecto %>" name="idProyecto">

        <div style="max-height: 20rem; overflow: scroll; overflow-x: hidden; text-align: start;">
          <h5>Riesgos de Calidad</h5>
          <% allRiesgos.map(riesgo => { %>
            <% if (riesgo.Categoria == "Calidad") { %>
              <% if (riesgo.active == true) { %>
                <input type="checkbox" id="box<%= riesgo.IDRiesgo %>" name="Checkbox<%= riesgo.IDRiesgo %>" checked>
              <% } else { %>
                <input type="checkbox" id="box<%= riesgo.IDRiesgo %>" name="Checkbox<%= riesgo.IDRiesgo %>">
              <% } %>
              <label style="border-bottom: solid gray 1px;"><%= riesgo.Riesgo %></label><br>
            <% } %>
          <% }) %>
          <h5>Riesgos de Alcance</h5>
          <% allRiesgos.map(riesgo => { %>
            <% if (riesgo.Categoria == "Alcance") { %>
              <% if (riesgo.active == true) { %>
                <input type="checkbox" id="box<%= riesgo.IDRiesgo %>" name="Checkbox<%= riesgo.IDRiesgo %>" checked>
              <% } else { %>
                <input type="checkbox" id="box<%= riesgo.IDRiesgo %>" name="Checkbox<%= riesgo.IDRiesgo %>">
              <% } %>
              <label style="border-bottom: solid gray 1px;"><%= riesgo.Riesgo %></label><br>
            <% } %>
          <% }) %> 
          <h5>Riesgos de Costo</h5>
          <% allRiesgos.map(riesgo => { %>
            <% if (riesgo.Categoria == "Costo") { %>
              <% if (riesgo.active == true) { %>
                <input type="checkbox" id="box<%= riesgo.IDRiesgo %>" name="Checkbox<%= riesgo.IDRiesgo %>" checked>
              <% } else { %>
                <input type="checkbox" id="box<%= riesgo.IDRiesgo %>" name="Checkbox<%= riesgo.IDRiesgo %>">
              <% } %>
              <label style="border-bottom: solid gray 1px;"><%= riesgo.Riesgo %></label><br>
            <% } %>
          <% }) %> 
          <h5>Riesgos de Recursos</h5>
          <% allRiesgos.map(riesgo => { %>
            <% if (riesgo.Categoria == "Recursos") { %>
              <% if (riesgo.active == true) { %>
                <input type="checkbox" id="box<%= riesgo.IDRiesgo %>" name="Checkbox<%= riesgo.IDRiesgo %>" checked>
              <% } else { %>
                <input type="checkbox" id="box<%= riesgo.IDRiesgo %>" name="Checkbox<%= riesgo.IDRiesgo %>">
              <% } %>
              <label style="border-bottom: solid gray 1px;"><%= riesgo.Riesgo %></label><br>
            <% } %>
          <% }) %> 
          <h5>Riesgos de Tiempo</h5>
          <% allRiesgos.map(riesgo => { %>
            <% if (riesgo.Categoria == "Tiempo") { %>
              <% if (riesgo.active == true) { %>
                <input type="checkbox" id="box<%= riesgo.IDRiesgo %>" name="Checkbox<%= riesgo.IDRiesgo %>" checked>
              <% } else { %>
                <input type="checkbox" id="box<%= riesgo.IDRiesgo %>" name="Checkbox<%= riesgo.IDRiesgo %>">
              <% } %>
              <label style="border-bottom: solid gray 1px;"><%= riesgo.Riesgo %></label><br>
            <% } %>
          <% }) %> 
        </div><br>
        <button class="btn-submit" type="submit">Guardar Cambios</button>
      </form>
    </div>
  </div>
  <!-- IMPLEMENTACIÓN : FUNCIONALIDAD DEL BOTÓN "Editar Riesgos" -->

</body>
<%- include('./../scripts/proj-script.ejs') %>
</html>